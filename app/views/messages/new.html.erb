<html>
		
	<head>
		<script type="text/javascript" lang="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    	</script>
		<script>
			$(document).ready(function() {
			  var inputTextToSave = $("#inputTextToSave");
			  var counter     = $("#counter");
			  var max_length  = counter.data("maximum-length");

			  inputTextToSave.keyup(function() {
				  counter.text(max_length - $(this).val().length);
			  });

			});
			
			$(document).ready(function(){
                $('#QRform').submit(function(event) {
                    var formData = new FormData();
                    formData.append("file", $('input[name="file"]')[0].files[0]);
                    event.stopPropagation();
                    event.preventDefault();
                    $.ajax({
                        url: $(this).attr("action"),
                        data: formData,
                        processData: false,
                        contentType: false,
                        type: 'POST',
                        success: function(data) {
                            var json_str = JSON.stringify(data[0]['symbol'][0]['data']);
                            var str = json_str.split('\\').join('');
                            var ret = str.substr(1, str.length-2);
                            $("#inputTextToSave").html(ret.split(' ').join('+'));
                        },
                        complete: function(response, textStatus) {
                            return console.log(response);
                        }
                    });
                    return false;
                  });
                });

			$(document).ready(function(){
				$('[data-behaviour~=datepicker]').datepicker()});
	
			function saveTextAsFile()
			{
				var textToSave = document.getElementById("inputTextToSave").value;
				var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
				var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
				var fileNameToSaveAs = document.getElementById("inputFileNameToSaveAs").value;

				var downloadLink = document.createElement("a");
				downloadLink.download = fileNameToSaveAs;
				downloadLink.innerHTML = "Download File";
				downloadLink.href = textToSaveAsURL;
				downloadLink.onclick = destroyClickedElement;
				downloadLink.style.display = "none";
				document.body.appendChild(downloadLink);

				downloadLink.click();
			}

			function destroyClickedElement(event)
			{
				document.body.removeChild(event.target);
			}

			function loadFileAsText()
			{
				var fileToLoad = document.getElementById("fileToLoad").files[0];

				var fileReader = new FileReader();
				fileReader.onload = function(fileLoadedEvent) 
				{
					var textFromFileLoaded = fileLoadedEvent.target.result;
					document.getElementById("inputTextToSave").value = textFromFileLoaded;
				};
				fileReader.readAsText(fileToLoad, "UTF-8");
			}
		</script>
	</head>
	
	
	<body>
		
		
		<% provide(:title, "Encrypt or Decrypt a message!") %>

		<h1>Encrypt or decrypt a message, <% if current_user.nil? %> visitor! <% else %><%= current_user.name %>!<% end %></h1>
		<% if current_user.nil? %><h4><center><%= link_to "Sign up", signup_path %> or <%= link_to "Log in", login_path %> to choose your own encryption key</center></h4><% end %>
		<div class="row">
			<div class="col-md-6 col-md-offset-3">
				
				<%= form_for :message do |f| %>
				
					<%= f.label :key %>
					<% if current_user.nil? %>
						<%= f.select :key, options_for_select([['Odysseus',1],['Homer',2],['Atlas',3],['Pleione',4]]) %>
					<% else %>
						<%= f.text_field :key, class: 'form-control', :placeholder => "We suggest you something that is known only from you and from your receiver" %>
					<% end %>
				
					<%= f.label :messaggio, "Message" %>
					<% if current_user.nil? %>
						<%= f.text_area :messaggio, id: "inputTextToSave", class: 'form-control', :placeholder => "Insert a message to be encrypted" %>Chars left: <span id="counter" data-maximum-length="<%= 15 %>"><%= 15 %></span><br><br>
					<% else %>
						<%= f.text_area :messaggio, id: "inputTextToSave", class: 'form-control', :placeholder => "Insert a message to be encrypted" %>
					<% end %>

					<%= f.label :'timeout' %>
						<%= f.text_field :'timeout', 'data-behaviour' => 'datepicker', :placeholder => "MM/DD/AAAA" %>
						
					<%= f.submit "Encrypt message", class: "btn btn-primary" %></br></br>
					<%= f.submit "Decrypt message", class: "btn btn-primary" %></br></br>
				<% end %>



				Select a .txt file to load:
				<input type="file" id="fileToLoad">
				<button onclick="loadFileAsText()" class = "btn btn-primary">Load Selected File</button><br><br>

				<form id="QRform" enctype="multipart/form-data" action="http://api.qrserver.com/v1/read-qr-code/" method="POST">
        		<!-- MAX_FILE_SIZE (maximum file size in bytes) must precede the file input field used to upload the QR code image -->
        		<input type="hidden" name="MAX_FILE_SIZE" value="1048576" />
        		<!-- The "name" of the input field has to be "file" as it is the name of the POST parameter -->
        		Choose QR Code image to read: <input name="file" type="file"/>
        		<input type="submit" class = "btn btn-primary" value="Read QR code"/>
        		</form>

			</div>
		</div>

</html>